/*! Bacillus.js 2014-09-10 */
function Cell(a){this.size=2,this.lifeTime=50,this.timeLeft=this.lifeTime,this.fatPerIteration=10,this.fatPerMove=1,this.canMove=!1,this.moveStep=2,this.reproductionAfter={age:3,fat:30},this.fatPerReproduce=this.reproductionAfter.fat,this.color=[33,87,181],this.pos=[Math.round(env.maxLeft/(2*this.size)),Math.round(env.maxTop/(2*this.size))],this.fat=0,$.extend(this,a||{}),_.isUndefined(env.places[this.pos[0]])&&(env.places[this.pos[0]]=[]),env.places[this.pos[0]][this.pos[1]]=!0,env.cells.push(this)}env={cells:[],places:[],maxLeft:1e3,maxTop:1e3,maxPopulation:5e3,chance:1e3,init:function(){var a=document.getElementById("field");a.width=env.maxLeft,a.height=env.maxTop;new Cell;this.iterator=setInterval(renderAll,100)},cataclysm:function(){var a=Math.round(100*Math.random());if(27===a){console.log("cataclysm"),clearInterval(this.iterator);var b=this.getCataclysmConditions(),c=[];this.cells.forEach($.proxy(function(a){a.lifeTime>b.lifeTime&&a.timeLeft>b.timeLeft?($.extend(a,a.changeColor()),c.push(a)):this.places[a.pos[0]][a.pos[1]]=void 0},this)),this.cells=c,this.iterator=setInterval(renderAll,100)}},getCataclysmConditions:function(){var a=_.max(this.cells,function(a){return a.lifeTime}),b=_.min(this.cells,function(a){return a.lifeTime}),c=(a.lifeTime+b.lifeTime)/2;return{lifeTime:c,timeLeft:c/2}}},$(function(){env.init(),$("#field").on("click",function(){{var a=$(this).offset();ev.clientX-a.left,ev.clientY-a.top}})});var renderAll=function(){env.cataclysm();var a,b=document.getElementById("field"),c=b.getContext("2d"),d=[];c.clearRect(0,0,b.width,b.height),env.cells.forEach(function(b){if(a=b.color,c.fillStyle="rgb("+a[0]+","+a[1]+","+a[2]+")",c.fillRect(b.pos[0]*b.size,b.pos[1]*b.size,b.size,b.size),b.timeLeft--,b.fat+=b.fatPerIteration,0!=b.timeLeft?d.push(b):env.places[b.pos[0]][b.pos[1]]=void 0,b.canReproduce()){var e=b.reproduce();e&&d.push(e)}else b.canMove&&b.move()}),env.cells=d};Cell.prototype.move=function(){if(this.fat>0){this.fat-=this.fatPerMove;var a=this.getNearestFreePlace();a&&(env.places[this.pos[0]][this.pos[1]]=void 0,_.isUndefined(env.places[a[0]])&&(env.places[a[0]]=[]),env.places[a[0]][a[1]]=!0,this.pos=a)}},Cell.prototype.reproduce=function(){this.fat-=this.fatPerReproduce;var a=this.getNearestFreePlace();if(!a)return!1;var b=this.getChildOptions({pos:a});return new Cell(b)},Cell.prototype.canReproduce=function(){var a=this.reproductionAfter;return this.fat>=a.fat&&env.cells.length<env.maxPopulation&&this.lifeTime-this.timeLeft>=a.age},Cell.prototype.getNearestFreePlace=function(){for(var a=this.pos[0],b=this.pos[1],c=[],d=a+1;d>=a-1;d-=1)if(d<env.maxLeft&&d>=0)for(var e=b+1;e>=b-1;e-=1)e<env.maxTop&&e>=0&&(_.isUndefined(env.places[d])||_.isUndefined(env.places[d][e]))&&c.push([d,e]);if(c.length>0){var f=Math.round(Math.random()*c.length);return c[f]}return!1},Cell.prototype.getChildOptions=function(a){var b=Math.round(Math.random()*env.chance),c=a||{};c.reproductionAfter=this.reproductionAfter;var d=this.reproductionAfter.age+(Math.round(10*Math.random())>5?-1:1);return c.reproductionAfter.age=d>0&&d<c.lifeTime?d:1,c.reproductionAfter.fat=10*c.reproductionAfter.age,$.extend(c,b>env.chance/2?this.changeLifeTime():{},b==Math.round(env.chance/3)?this.changeColor():{},b>env.chance/10&&b<2*env.chance/10?this.changeMovable():{})},Cell.prototype.changeSize=function(){return{size:this.size+1}},Cell.prototype.changeLifeTime=function(){var a=Math.round(10*Math.random()),b=this.lifeTime+(a>5?5-a:a);return{lifeTime:b,timeLeft:b}},Cell.prototype.changeColor=function(){var a=Math.round(3*Math.random()),b=this.color;return b[a]=this.color[a]+5<255?this.color[a]+5:0,{color:b}},Cell.prototype.changeMovable=function(){return{canMove:!0,lifeTime:this.lifeTime+100,timeLeft:this.lifeTime+100,fatPerIteration:15,reproductionAfter:{age:this.reproductionAfter.age-2,fat:this.reproductionAfter.fat-10}}};